<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>JSON → Go Struct • DevTools</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div class="container page">
      <div class="header">
        <a class="brand" href="/"><span class="dot"></span> DevTools</a>
      </div>
      <h1>JSON → Go Struct</h1>
      <div class="two">
        <div class="field">
          <div class="label">JSON</div>
          <textarea
            id="json"
            class="code"
            placeholder='{"id":1,"name":"Alice","tags":["a","b"],"meta":{"ok":true}}'
          ></textarea>
          <div class="row">
            <input
              id="name"
              class="input"
              placeholder="Root name (default: AutoGenerated)"
              style="max-width: 280px"
            /><button class="btn" id="gen">Generate</button>
          </div>
        </div>
        <div class="field">
          <div class="label">Go</div>
          <textarea id="out" class="code" style="min-height: 320px"></textarea>
          <div class="row">
            <button class="btn ghost" id="copy">Copy</button>
          </div>
        </div>
      </div>
      <div class="small" id="err"></div>
    </div>
    <div class="toast"></div>
    <script src="/app.js"></script>
    <script>
      function title(s) {
        return s
          .replace(/(^|_|-|\s)+(\w)/g, (_, a, b) => b.toUpperCase())
          .replace(/[^A-Za-z0-9]/g, "");
      }
      function isInt(n) {
        return Number.isInteger(n);
      }
      function infer(v, name, defs) {
        if (v === null) return "any";
        const t = typeof v;
        if (t === "string") return "string";
        if (t === "number") return isInt(v) ? "int" : "float64";
        if (t === "boolean") return "bool";
        if (Array.isArray(v)) {
          if (v.length === 0) return "[]any";
          const types = new Set(v.map((x) => infer(x, name, defs)));
          if (types.size === 1) {
            const it = [...types][0];
            return "[]" + it;
          } else {
            return "[]any";
          }
        }
        if (t === "object") {
          const typeName = title(name || "AutoGenerated");
          if (!defs[typeName]) {
            const fields = Object.entries(v).map(([k, val]) => {
              const fieldName = title(k);
              const typ = infer(val, fieldName, defs);
              return { fieldName, json: k, type: typ };
            });
            defs[typeName] = fields;
          }
          return typeName;
        }
        return "any";
      }
      function genGo(obj, root) {
        const defs = {};
        const rootType = infer(obj, root || "AutoGenerated", defs);
        let out = "package main\n\n";
        out +=
          "type " +
          (root || "AutoGenerated") +
          " " +
          renderType(rootType) +
          "\n\n";
        for (const [name, fields] of Object.entries(defs)) {
          out += "type " + name + " struct {\n";
          for (const f of fields) {
            out +=
              "  " +
              f.fieldName +
              " " +
              renderType(f.type) +
              ' `json:"' +
              f.json +
              '"`\n';
          }
          out += "}\n\n";
        }
        function renderType(t) {
          if (t.startsWith("[]")) return "[]" + renderType(t.slice(2));
          if (t === "any") return "interface{}";
          return t;
        }
        return out;
      }
      $("#gen").onclick = () => {
        try {
          const obj = JSON.parse($("#json").value);
          const name = $("#name").value || "AutoGenerated";
          $("#out").value = genGo(obj, name);
          $("#err").textContent = "";
        } catch (e) {
          $("#err").textContent = "Invalid JSON";
        }
      };
      $("#copy").onclick = () => copyText($("#out"));
    </script>
  </body>
</html>
